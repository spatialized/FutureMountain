const NatCorderWebGL={$sharedInstance:{recordingCallback:null,recordingContext:null,framebuffer:null,framebufferContext:null,pixelBuffer:null,audioContext:null,audioStream:null,recorder:null,MIME_TYPE:"video/webm"},NCCreateMP4Recorder:function(e,n,a,r,t,o,s){sharedInstance.framebuffer=document.createElement("canvas"),sharedInstance.framebuffer.width=e,sharedInstance.framebuffer.height=n,sharedInstance.framebufferContext=sharedInstance.framebuffer.getContext("2d"),sharedInstance.pixelBuffer=sharedInstance.framebufferContext.getImageData(0,0,e,n);const c=[sharedInstance.framebuffer.captureStream(a).getVideoTracks()[0]];0!=o&&0!=s&&(sharedInstance.audioContext=new AudioContext({latencyHint:"interactive",sampleRate:o}),sharedInstance.audioStream=sharedInstance.audioContext.createMediaStreamDestination({channelCount:s,channelCountMode:"explicit"}),c.push(sharedInstance.audioStream.stream.getAudioTracks()[0]));const d={mimeType:sharedInstance.MIME_TYPE,videoBitsPerSecond:r};return sharedInstance.recorder=new MediaRecorder(new MediaStream(c),d),1},NCCreateGIFRecorder:function(e,n,a){return 0},NCCreateHEVCRecorder:function(e,n,a,r,t,o,s){return 0},NCStartRecording:function(e,n,a,r){sharedInstance.recordingCallback=a,sharedInstance.recordingContext=r,sharedInstance.recorder.start(),console.log("NatCorder: Starting recording")},NCStopRecording:function(e){console.log("NatCorder: Stopping recording"),sharedInstance.recorder.ondataavailable=function(e){const n=new Blob([e.data],{type:sharedInstance.MIME_TYPE}),a=URL.createObjectURL(n);console.log("NatCorder: Completed recording video",n,"to URL:",a);const r=lengthBytesUTF8(a)+1,t=_malloc(r);stringToUTF8(a,t,r),Runtime.dynCall("vii",sharedInstance.recordingCallback,[sharedInstance.recordingContext,t]),_free(t)},sharedInstance.recorder.stop(),sharedInstance.audioContext&&sharedInstance.audioContext.close(),sharedInstance.recorder=null,sharedInstance.framebuffer=null,sharedInstance.framebufferContext=null,sharedInstance.pixelBuffer=null,sharedInstance.audioContext=null},NCEncodeFrame:function(e,n,a,r){for(var t=sharedInstance.pixelBuffer.width,o=sharedInstance.pixelBuffer.height,s=4*t,c=0;c<o;c++)sharedInstance.pixelBuffer.data.set(new Uint8Array(HEAPU8.buffer,n+(o-c-1)*s,s),c*s);sharedInstance.framebufferContext.putImageData(sharedInstance.pixelBuffer,0,0)},NCEncodeSamples:function(e,n,a,r){const t=sharedInstance.audioContext.createBuffer(sharedInstance.channelCount,a/sharedInstance.channelCount,sharedInstance.sampleRate);n=new Float32Array(HEAPU8.buffer,n,a);for(var o=0;o<t.numberOfChannels;o++){const e=t.getChannelData(o);for(var s=0;s<t.length;s++)e[s]=n[s*t.numberOfChannels+o]}var c=sharedInstance.audioContext.createBufferSource();c.buffer=t,c.connect(sharedInstance.audioStream),c.start()},NCCurrentTimestamp:function(){return Math.round(1e6*performance.now())}};autoAddDeps(NatCorderWebGL,"$sharedInstance"),mergeInto(LibraryManager.library,NatCorderWebGL);